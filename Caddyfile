# Caddyfile for SemStreams UI Static SPA
# Serves static files and proxies API requests to Go backend

{
	# Global options
	auto_https off
	admin off
}

:3000 {
	# Handle API routes first (proxy to backend)
	handle /flowbuilder/* {
		reverse_proxy {$BACKEND_URL:http://backend:8080}
	}

	handle /components/* {
		reverse_proxy {$BACKEND_URL:http://backend:8080}
	}

	handle /health {
		reverse_proxy {$BACKEND_URL:http://backend:8080}
	}

	handle /api/* {
		reverse_proxy {$BACKEND_URL:http://backend:8080}
	}

	# Handle static files and SPA routes
	handle {
		root * /usr/share/caddy
		try_files {path} /index.html
		file_server
	}

	# Security headers
	header {
		# Enable HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent MIME sniffing
		X-Content-Type-Options "nosniff"
		# Enable XSS protection
		X-XSS-Protection "1; mode=block"
		# Control referrer information
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Enable gzip compression
	encode gzip

	# Logging - stdout is Docker best practice (12-factor app)
	# Docker captures stdout/stderr and routes to logging systems
	# For production, use LOG_LEVEL env var to control verbosity
	log {
		output stdout
		format json  # JSON for log aggregators (CloudWatch, Datadog, etc.)
		level {$LOG_LEVEL:INFO}  # Configurable: DEBUG, INFO, WARN, ERROR
	}
}
